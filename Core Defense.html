<!DOCTYPE html>
<html>

<head>
    <title>Core Defense</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
        canvas {
            position: relative;
        }
        
        cellTime {
            position: fixed;
            right: 180px;
            top: 570px;
        }
        
        /* Esta clase define la anchura del contenido y la posicion centrada 
           El contenido queda centrado y limitado, pero el pie
           llegan hasta los limites del navegador.
        */
        .define {
            width: 960px;
            margin: 0 auto;
        }
    </style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="js/jugador.js"></script>
	<script src="js/casilla.js"></script>
	<script src="js/mundo.js"></script>
	<script src="js/shootingController.js"></script>
	<script src="js/bala.js"></script>
	
    <script type="text/javascript">
		$( document ).ready(function() {
			//initGame();
		});
	
        //!!!!!!!!!PUEDES SUSTITUIR CELLSIZE POR 5,10 O 20 PARA CAMBIAR EL NUMERO DE casillaS, sin embargo ya hay botones para eso.
        
        var canvas;
        var context;
        var timerId = undefined; //undefined si esta parado.
        
        var extra = 1; //Separa 1 pixel entre casillas cuando hay rendija.
        var rendija = true; //True si hay rendija activa
        var m = new mundo(); //Objeto mundo
        
		
        var m_vert = new Image();
		var m_hor = new Image();
		var m_ArI = new Image();
		var m_ArD = new Image();
		var m_AbI = new Image();
		var m_AbD = new Image();
		var m_Fondo = new Image();
		var m_Bordes = new Image();
		var m_Core0 = new Image();
		var m_Core1 = new Image();
		var m_Core2 = new Image();
		var m_Core3 = new Image();
		var m_Aparicion = new Image();
		var m_Bala = new Image();
		
		//var estado = 0;//Para saber que "tile" se esta usando
		
		var personaje_1 = new Image();
		
        //Carga de Sprites
        function loadImages(){
			//Tiles
            m_vert.src = 'src/2.png';
			m_hor.src = 'src/3.png';
			m_ArI.src = 'src/4.png';
			m_ArD.src = 'src/5.png';
			m_AbI.src = 'src/7.png';
			m_AbD.src = 'src/6.png';
			m_Fondo.src = 'src/0.png';
			m_Bordes.src = 'src/1.png';
			m_Core0.src = 'src/8.png';
			m_Core1.src = 'src/9.png';
			m_Core2.src = 'src/A.png';
			m_Core3.src = 'src/B.png';
			m_Aparicion.src = 'src/C.png';
			m_Bala.src = 'src/personaje_1.png';
			
			//Personajes
			personaje_1.src = 'src/sprite1.png';
        }

        //INICIALIZA TODO
        function initGame() {
            canvas = document.getElementById("game");
            context = canvas.getContext("2d");
            //canvas.addEventListener("click", m.onCanvasClick, false);
			loadImages();
			
			$.ajax({
				dataType: "json",
				url: "json/mapa.json",
				mimeType: "application/json",
				success: function(result){
					m.initMundo(context, result);
					/*for (i = 0;i<18;i++){
						console.log("Resultados de la fila "+result.filas[i].fila);
						for (j=0;j<18;j++){
							console.log("Columna "+result.filas[i].datos[j].columna+" y tile "+result.filas[i].datos[j].tile);
						}
					}*/
				}
			});
            
			//m.pintado();
			
        }
		
		/*$.getJSON( "ajax/test.json", function( data ) {
		  var items = [];
		  $.each( data, function( key, val ) {
			//items.push( "<li id='" + key + "'>" + val + "</li>" );
			console.log(key+" "+val);
		  });
		 
		  /*$( "<ul/>", {
			"class": "my-new-list",
			html: items.join( "" )
		  }).appendTo( "body" );
		});*/
		
		
        
        //BUCLE DE EJECUCION DEL JUEGO, AQU√ç DEBEN INCLUIRSE LAS FUNCIONES QUE SE EJECUTEN CONTINUAMENTE
        function computeNS() {
			//if (m.isCargado());
			
				//m.pintado();
				
			//Este try para firefox, porque no espera a cargar las imagenes y puede saltar error
			//En chrome no hay problema
			try {
				m.pintado();
			} catch (e) {
					if (e.name == "NS_ERROR_NOT_AVAILABLE") {
						setTimeout(computeNS, 100);
				} else {
					throw e;
				}
			}
        }
        
        //PARA TESTEO: Si pulsas play empieza el bucle
        function startNS() {
			//computeNS();
            if (!timerId) {
                timerId = setInterval("computeNS()", 30);
				//1000 1 frame por segundo
				//100 10 frames por segundo
				//50 20 frames por segundo
				//25 40 frames por segundo
				
                //var status = document.getElementById("status");
                //status.innerHTML = "<b>Play</b>";
            }
        }
		
        //Para el tiempo de ejecucion, se llama desde stop
        /*function stopNS() {
            clearInterval(timerId);
            timerId = undefined;
            var status = document.getElementById("status");
            status.innerHTML = "<b>Pausa</b>";
        }*/
		
        //PARA TESTEO: Si pulsas stop detienes el juego y limpias todo
        /*function clearBoard() {
            m.initMundo();
            m.pintado();
            stopNS(); //(no tiene sentido ejecutar el mundo si esta vacio)
            var status = document.getElementById("status");
            status.innerHTML = "<b>Stop</b>";
        }*/
        
		//////////////////////////////////////////////////////////
		//Para varias pulsaciones de teclas a la vez
		/*var map = {68: false, 69: false, 86: false};
		$(document).keydown(function(e) {
			if (e.keyCode in map) {
				map[e.keyCode] = true;
				if (map[68] && map[69] && map[86]) {
					// FIRE EVENT
				}
			}
		}).keyup(function(e) {
			if (e.keyCode in map) {
				map[e.keyCode] = false;
			}
		});*/
		
		//Para saber cuando se pulsan las teclas
		document.onkeypress = function(evt) {
			evt = evt || window.event;
			var charCode = evt.keyCode || evt.which;
			var charStr = String.fromCharCode(charCode);
			
			//console.log(charStr);
			
			switch (charStr){
				/*case "1":
					estado = 1;
					break;
				case "2":
					estado = 2;
					break;
				case "3":
					estado = 3;
					break;
				case "4":
					estado = 4;
					break;
				case "5":
					estado = 5;
					break;
				case "6":
					estado = 6;
					break;
				case "7":
					estado = 7;
					break;
				case "8":
					estado = 8;
					break;*/
					
				case "w":
				case "W":
					m.moverJugador(0);
					break;
				case "s":
				case "S":
					m.moverJugador(1);
					break;
				case "a":
				case "A":
					m.moverJugador(2);
					break;
				case "d":
				case "D":
					m.moverJugador(3);
					break;
					
				case "f":
				case "F":
					m.disparar();
					break;
			}
		};
		
		startNS();

		/*setTimeout(function(){
    		startNS();
		}, 1000);*/
    </script>
</head>

<body onload="initGame()" bgcolor="#37383C">
    <p align="center">
        <img src="src/titulo.png">
    </p>
    <p align="center">
        <canvas id="game" width="720" height="720" border="1"></canvas>
    </p>
    <p align="center">
        <span id="cellTime" style="color: #FF920E;"></span></p>
</body>

</html>